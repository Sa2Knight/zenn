---
title: "@babel/preset-env (Babel 7)ã‚’ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¡ã‚ƒã‚“ã¨ç†è§£ã™ã‚‹"
emoji: "ğŸ”¨"
type: "tech"
topics:
  - "nodejs"
  - "babel"
published: true
published_at: "2020-11-02 11:00"
---

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

||version|
|----|-------|
|node|12.16.3|
|@babel/core|7.9.0|
|@babel/preset-env|7.9.5|
|@babel/cli|7.8.4|
|browserslist|4.12.0|

# `@babel/preset-env` ã¨ã¯

`@babel/preset-env` ã¯ã€ `babel` ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã“ã¨ã§ã™ã€‚

ãã‚‚ãã‚‚ `babel` ã®æœ¬ä½“(`@babel/core`)ã¯ã€ã€ŒJSã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€ASTã«å¤‰æ›å¾Œã€**ä½•ã‚‰ã‹ã®å¤‰æ›å‡¦ç†**ã‚’è¡Œã„ã€å¤‰æ›å¾Œã®ASTã‹ã‚‰å†åº¦JSã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€ãŒè²¬å‹™ã§ã‚ã‚Šã€ **ä½•ã‚‰ã‹ã®å¤‰æ›å‡¦ç†**ã‚’æŒ‡å®šã—ãªã‘ã‚Œã°ã€ä½•ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚‚è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

ã“ã® **ä½•ã‚‰ã‹ã®å‡¦ç†** ã«è©²å½“ã™ã‚‹å®Ÿè£…ãŒbabelãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã“ã¨ã§ã€é–‹ç™ºè€…ã¯å®Ÿç¾ã—ãŸã„ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã«å¿œã˜ã¦é©åˆ‡ãª babel ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹è¨­å®šã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

...ã§ã‚‚é¢å€’ã§ã™ã‚ˆã­ï¼Ÿ

å˜ç´”ã«IEã‚’å«ã‚€ä¸»è¦ãªãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸€é€šã‚Šã®ES6ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ãŸã„ã ã‘ã¨ã„ã†ã®ãŒã ã„ãŸã„ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚

ãã‚“ãªæ™‚ã€å¯¾å¿œãƒ–ã‚¦ãƒ©ã‚¦ã‚¶ãªã©ã®å¤§é›‘æŠŠãªæƒ…å ±ã‚’å…ƒã«ã€å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è‡ªå‹•ã§é¸æŠã—ã¦ã€æœ€æ–°ã® ES6+ ã‚’å‹•ãçŠ¶æ…‹ã«ã—ã¦ãã‚Œã‚‹è¶…ä¾¿åˆ©ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒ `@babel/preset-env` ã§ã™ã€‚

ãªã‚“ã¨ãªãã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ã„ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å‹•ä½œç¢ºèªç”¨ã® cli ã‚‚å«ã‚ã¦å…¥ã‚Œã¾ã™ã€‚

```bash
$ yarn add -D @babel/cli @babel/preset-env
```

# ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„

æœ¬è¨˜äº‹ã§ã¯ã€å®Ÿéš›ã« `@babel/cli` ã¨ `@babel/preset-env` ã‚’ä½¿ã£ã¦ã€Javascriptã®ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›ã•ã‚Œã‚‹æ§˜å­ã‚’ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§è¦‹ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯ä»¥ä¸‹ã®ã‚ˆã†ãª `script.js` ã‚’ä½œæˆã—ã¾ã™ã€‚

```javascript
class User {
  constructor(name) {
    this.name = name
  }
  sayHello() {
    return `Hello, ${this.name}`
  }
  async fetch() {
    return await new Promise(resolve => {
      setTimeout(() => {
        resolve('complete!!')
      }, 1000)
    })
  }
}

const user = new User('sasaki')
console.log(user.sayHello())

user.fetch().then(result => {
  console.log(result)
})
```

ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã¯

- ã‚¯ãƒ©ã‚¹æ§‹æ–‡
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—
- Promise
- async/await

ã¨è¨€ã£ãŸã€ç¾ä»£ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯å®šç•ªã ã‘ã©ã€ä¾ç„¶ã¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›ã«æ‚©ã¾ã•ã‚Œã‚‹è¦ç´ ã‚’è©°ã‚è¾¼ã‚“ã ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã¾ã™ã€‚

# babelã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹

ã¾ãšã¯ä½•ã‚‚è€ƒãˆãšã« `script.js` ã‚’ babel ã«ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ babel script.js 
```

ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```javascript
class User {
  constructor(name) {
    this.name = name;
  }

  sayHello() {
    return `Hello, ${this.name}`;
  }

  async fetch() {
    return await new Promise(resolve => {
      setTimeout(() => {
        resolve('complete!!');
      }, 1000);
    });
  }

}

const user = new User('sasaki');
console.log(user.sayHello());
user.fetch().then(result => {
  console.log(result);
});
```

**ãªã‚“ã¨ã„ã†ã“ã¨ã§ã—ã‚‡ã†ã€ä½•ä¸€ã¤å¤‰ã‚ã£ã¦ã„ã¾ã›ã‚“**

ãã‚Œã‚‚ãã®ã¯ãšã€ã¾ã  babel ã®è¨­å®šã‚’ä½•ã‚‚å®šç¾©ã—ã¦ã„ãªãã€å½“ç„¶  `@babel/preset-env` ã‚‚ä½¿ã‚ã‚Œã¦ã„ãªã„ã®ã§ã€ä½•ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚‚ã•ã‚Œãšã«ã€å…¥åŠ›ã‚’ãã®ã¾ã¾å‡ºåŠ›ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

ã§ã¯ã“ã“ã‹ã‚‰ã€ `.babelrc` ã« babel ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

# ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ãã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹

`.babelrc` ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ `@babel/preset-env` ã‚’ä½¿ã†ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚

```json
{
  "presets": [
    [
      "@babel/preset-env"
    ]
  ]
}
```

ã¾ãŸã€`package.json` ã« `browserslist` ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã¯ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã‚’æ˜è¨˜ã™ã‚‹æ–¹æ³•ã«ãªã‚Šã¾ã™ã€‚ 

```json
"browserslist": [
  "> 2%"
]
```

(`.babelrc` ã«ã¾ã¨ã‚ã¦æ›¸ã„ãŸã‚Šã€ `.browserslistrc` ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ä¾¿å®œä¸Š `package.json` ã«åˆ†é›¢ã—ã¦æ›¸ãã¾ã™)

ã¾ãšã¯ä¸Šè¨˜ã®ã‚ˆã†ã«ã€ **ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã®ãƒ–ãƒ©ã‚¦ã‚¶** ã‚’å¯¾è±¡ã¨ã™ã‚‹è¨­å®šã«ã—ã¦ã€ã‚‚ã†ä¸€åº¦ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ babel script.js 
```

```javascript
"use strict";

class User {
  constructor(name) {
    this.name = name;
  }

  sayHello() {
    return `Hello, ${this.name}`;
  }

  async fetch() {
    return await new Promise(resolve => {
      setTimeout(() => {
        resolve('complete!!');
      }, 1000);
    });
  }

}

const user = new User('sasaki');
console.log(user.sayHello());
user.fetch().then(result => {
  console.log(result);
});
```

ãŠã‚„ãŠã‚„ï¼Ÿ ã¾ã çµæœãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‚ˆã†ã§ã™(å…ˆé ­ã« `use strict` ã¯ä»˜ä¸ã•ã‚Œã¾ã—ãŸãŒ)

ã¨ã„ã†ã®ã‚‚ã€ **ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã®ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ã‚³ãƒ¬ãã‚‰ã„ãã®ã¾ã¾å‹•ãã®ã§å¤‰æ›ä¸è¦** ãªã‚ˆã†ã§ã™ã€‚(2020/05/07ç¾åœ¨)

ã§ã¯ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã¨ã¯ã©ã‚“ãªãƒ–ãƒ©ã‚¦ã‚¶ã§ã—ã‚‡ã†ã‹ï¼Ÿä¾‹ã®ã‚ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½•ï¼…ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚

# å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ç¢ºèªã™ã‚‹

`@babel/preset-env` ã§ã¯ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã®å¯¾è±¡ã¨ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã€[browserslist](https://github.com/browserslist/browserslist) ã«å¾“ã£ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`browserslist` ã¯ã€ç•°ãªã‚‹ãƒ„ãƒ¼ãƒ«é–“ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®å¯¾è±¡ç¯„å›²ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã§ã€ `browserslit` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã™ã‚‹ã¨ã€ `package.json` ã«è¨˜è¿°ã—ãŸã‚ˆã†ãªãƒ«ãƒ¼ãƒ«ã‚’å…ƒã«ã€å®Ÿéš›ã®å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ãŒã©ã‚“ãªã‚‚ã®ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã•ã£ããå…¥ã‚Œã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ yarn add -D browserslist
```

ä¸€å¿œãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’æœ€æ–°åŒ–ã—ã¦ãŠãã¨è‰¯ã•ãã†ã§ã™

```bash
$ yarn browserslist --update-db
```

ã•ã¦ã€ã“ã®çŠ¶æ…‹ã§ã€å…ˆç¨‹åŒæ§˜ã« `package.json` ã«ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã®æ—¨ãŒè¨˜è¼‰ã•ã‚ŒãŸçŠ¶æ…‹ã§ `browserslist` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```json
"browserslist": [
  "> 2%"
]
```

```bash
$ yarn browserslist
and_chr 81
chrome 80
ios_saf 13.3
safari 13
samsung 11.1
```

ãªã‚‹ã»ã©ãªã‚‹ã»ã©ã€‚ChromeãŒãƒ€ãƒ³ãƒˆãƒ„ãªã®ã¯äºˆæƒ³ã§ãã¾ã™ãŒã€ä»–ã«ã¯safariã¨ã€å„ç¨®ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãŒ2%ä»¥ä¸Šã‚’ç¶­æŒã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚

ä¾‹ã® `I` ã§å§‹ã¾ã£ã¦ `E` ã§çµ‚ã‚ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ãŒå…¥ã£ã¦ã„ãªã„ã®ã§ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãŒä¸è¦ã¨ã„ã†ã‚‚ã®ç´å¾—ã§ãã¾ã™ã€‚

# ã‚·ã‚§ã‚¢ç‡1%ä»¥ä¸Šã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ãã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹

**ã§ã¯ã‚·ã‚§ã‚¢ç‡ã‚’1%ä»¥ä¸Šã«å¼•ãä¸‹ã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚**

```json
"browserslist": [
  "> 1%"
]
```

```bash
$ browserslist
and_chr 81
and_uc 12.12
chrome 80
chrome 79
edge 18
firefox 74
firefox 73
ie 11
ios_saf 13.3
ios_saf 12.2-12.4
safari 13
samsung 11.1
```

2%ä»¥ä¸Šã‚’1%ä»¥ä¸Šã«å¼•ãä¸‹ã’ãŸã ã‘ã§ã™ãŒã€ `IE` `edge` `firefox` ãŒå…¥ã£ã¦ããŸã‚Šã€æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®iOS safariãŒé£Ÿã„è¾¼ã‚“ã§ããŸã‚Šã‚‚ã—ã¾ã™ã€‚

ã“ã‚Œã¯æµçŸ³ã«å…ƒã‚³ãƒ¼ãƒ‰ã®ã¾ã¾ã˜ã‚ƒå®Ÿè¡Œã§ããªã„ã¯ãšãªã®ã§ã€babelã‚’ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ babel script.js 
```

```javascript
"use strict";

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var User = /*#__PURE__*/function () {
  function User(name) {
    _classCallCheck(this, User);

    this.name = name;
  }

  _createClass(User, [{
    key: "sayHello",
    value: function sayHello() {
      return "Hello, ".concat(this.name);
    }
  }, {
    key: "fetch",
    value: function () {
      var _fetch = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _context.next = 2;
                return new Promise(function (resolve) {
                  setTimeout(function () {
                    resolve('complete!!');
                  }, 1000);
                });

              case 2:
                return _context.abrupt("return", _context.sent);

              case 3:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      function fetch() {
        return _fetch.apply(this, arguments);
      }

      return fetch;
    }()
  }]);

  return User;
}();

var user = new User('sasaki');
console.log(user.sayHello());
user.fetch().then(function (result) {
  console.log(result);
});
```

**è¦‹äº‹ã«ãã‚Œã‚‰ã—ã„ã‚³ãƒ¼ãƒ‰ã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¾ã—ãŸï¼**

`@babel/preset-env` ã®åŠ›ã«ã‚ˆã£ã¦ã€ `browserslist` ã«å‰‡ã£ã¦å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å®šç¾©ã—ãŸã ã‘ã§è‰¯ã„æ„Ÿã˜ã«å¤‰æ›ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

# ã‚·ã‚§ã‚¢ç‡ã¨ã‹é–¢ä¿‚ãªãIEã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹

ã•ã¦ã€å…ˆç¨‹ã¯ã‚·ã‚§ã‚¢ç‡1%ä»¥ä¸Šã¨æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ `IE` ã•ãˆã‚‚ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

ã—ã‹ã—ã€ã“ã®å…ˆ `IE` ã®ã‚·ã‚§ã‚¢ç‡ãŒ1%ã‚’ä¸‹å›ã£ãŸå ´åˆã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼ŸåŒã˜è¨­å®šã‚’ä½¿ã„ç¶šã‘ã¦ã„ã‚‹ã¨ã€ã‚·ã‚§ã‚¢ç‡ãŒä¸‹å›ã£ãŸç¬é–“ã‹ã‚‰ã€ `IE` ãŒã‚µãƒãƒ¼ãƒˆã®å¯¾è±¡ã‹ã‚‰å¤–ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

**ã©ã‚“ãªã«IEã®ã‚·ã‚§ã‚¢ç‡ãŒä½ã¾ã£ã¦ã‚‚IEã‚µãƒãƒ¼ãƒˆã‚’ç¶šã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†å‘ªã‚ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹** ã«ã¨ã£ã¦ã¯å„ä»‹ãªå•é¡Œã§ã™ã€‚

ãã“ã§ã€ `browserslit` ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```package.json
  "browserslist": [
    "> 2%",
    "IE 11"
  ]
```

ä¸Šè¨˜è¨­å®šã¯ã€ **ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã€ã¾ãŸã¯IE11** ã¨ã„ã†ã€æ‚²ã—ã¿ã®æº¢ã‚Œã‚‹è¨­å®šã«ãªã‚Šã¾ã™ã€‚

```bash
$ yarn browserslist
and_chr 81
chrome 80
ie 11
ios_saf 13.3
safari 13
samsung 11.1
```

ãªã‚“ã¨ã„ã†ã“ã¨ã§ã—ã‚‡ã†ã€ã‚·ã‚§ã‚¢ç‡2%ä»¥ä¸Šã®äººæ°—ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã«IE11ãŒç´›ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã€‚

```
$ babel script.js
```

```javascript
"use strict";

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var User = /*#__PURE__*/function () {
  function User(name) {
    _classCallCheck(this, User);

    this.name = name;
  }

  _createClass(User, [{
    key: "sayHello",
    value: function sayHello() {
      return "Hello, ".concat(this.name);
    }
  }, {
    key: "fetch",
    value: function () {
      var _fetch = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _context.next = 2;
                return new Promise(function (resolve) {
                  setTimeout(function () {
                    resolve('complete!!');
                  }, 1000);
                });

              case 2:
                return _context.abrupt("return", _context.sent);

              case 3:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      function fetch() {
        return _fetch.apply(this, arguments);
      }

      return fetch;
    }()
  }]);

  return User;
}();

var user = new User('sasaki');
console.log(user.sayHello());
user.fetch().then(function (result) {
  console.log(result);
});
```

ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã®çµæœã‚‚ã€ã‚·ã‚§ã‚¢ç‡1%ä»¥ä¸Šã®ã¨ãã¨ã¾ã£ãŸãåŒã˜ã§ã™ã€‚ã¤ã¾ã‚‹ã¨ã“ã‚ã€ã“ã“ã¾ã§å®Ÿè¡Œã—ã¦ããŸãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã¯å…¨ã¦IE11ã®ãŸã‚ã®ã‚‚ã®ã ã£ãŸã®ã§ã™ã€‚

# IEã§PromiseãŒå‹•ãã‚ã‘ç„¡ã„ã ã‚

ã“ã“ã¾ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸçµæœã®ä¸­ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒæ··ã˜ã£ã¦ã„ã¾ã—ãŸã€‚

```javascript
switch (_context.prev = _context.next) {
  case 0:
    _context.next = 2;
    return new Promise(function (resolve) {
      setTimeout(function () {
        resolve('complete!!');
      }, 1000);
    });
```

`new Promise` ...??

ä»¥ä¸‹ã® `Can I use...` ã‚’è¦‹ã¦åˆ†ã‹ã‚‹é€šã‚Šã€ `IE11` ã¯ä¾ç„¶ã¨ã—ã¦ `Promise` ã‚’ä¸€åˆ‡ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/pzr8b00q4tke480jfv1cwcuw40ve)

ãªã®ã«IE11ã‚’å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã—ãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚’ã—ãŸã¾ã¾ãªã®ã«ã€ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒç”Ÿã¾ã‚Œã¦ã—ã¾ã†ã®ã¯ä½•æ•…ã§ã—ã‚‡ã†ã‹â€¦??

ãã†ã€ `@babel/preset-env` ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ `Polyfill` ã¯è¡Œã£ã¦ãã‚Œã¾ã›ã‚“ã€‚ã¨ã„ã†ã‚ˆã‚Šãã‚‚ãã‚‚ `babel` ã®è²¬å‹™ã¯æ§‹æ–‡ã®è©±ã§ã‚ã£ã¦ã€`Promise` ã®ã‚ˆã†ãªè¿½åŠ æ©Ÿèƒ½ã«å¯¾ã—ã¦ã¯åˆ¥é€”å¯¾å¿œãŒå¿…è¦ãªã®ã§ã™ã€‚

*â€» [ãƒãƒªãƒ•ã‚£ãƒ«ã¨ã¯ã€æœ€è¿‘ã®æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã€ãã®æ©Ÿèƒ½ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚å¤§æŠµã¯ã‚¦ã‚§ãƒ–ä¸Šã® JavaScript ã§ã™ã€‚](https://developer.mozilla.org/ja/docs/Glossary/Polyfill)*

ã¨ã¯ã„ãˆã€ç¾ä»£ã® `@babel/preset-env` ã§ã¯ã€`Polyfill`ã‚‚ã©ã†ã«ã‹ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

# Polyfillç”¨ã®core-jsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

Polyfill ã«ã¯ä¸€èˆ¬çš„ã« `core-js` ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã‚Œã¯Javascriptã®æ–°æ©Ÿèƒ½ã‚’æ—§ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹äº’æ›ã‚³ãƒ¼ãƒ‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ç¾åœ¨ã¯ `2.x`ç³» ã¨ `3.x`ç³» ãŒä¸»æµã§ã™ã€‚

`@babel/preset-env` ã§ã¯ä¸€å¿œã©ã¡ã‚‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ `3.x` ã‚’ä½¿ã„ã¾ã™ã€‚

```bash
$ yarn add -D core-js@3
```

# `@babel/preset-env` ã§ Polyfill ã™ã‚‹

ã¾ãšé–‹ãç›´ã£ã¦IEã ã‘ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹è¨­å®šã«ã—ã¡ã‚ƒã„ã¾ã™ã€‚

```json
  "browserslist": [
    "IE 11"
  ]
```

```bash
$ yarn browserslist
ie 11
```

ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚‚ã€æœ€é«˜ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ã—ã¾ã™ã€‚

```javascript
Promise.resolve()
```

`.babelrc` ã¯å¤‰æ›´ã›ãšã«ãã®ã¾ã¾ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã‚»ãƒŸã‚³ãƒ­ãƒ³ãŒã¤ã„ãŸç¨‹åº¦ã§ã€Polyfillã¯è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```bash
$ yarn babel script.js
```

```javascript
"use strict";

Promise.resolve();
```

ã“ã“ã§ã€ `.babelrc` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ `useBuiltIns` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã€ `corejs` ã¯ `3.x` ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

```json:.babelrc
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage",
        "corejs": 3
      }
    ]
  ]
}
```

```bash
$ yarn babel script.js
```

```javascript
"use strict";

require("core-js/modules/es.object.to-string");

require("core-js/modules/es.promise");

Promise.resolve();
```

`require("core-js/modules/es.promise");` ã®ã‚ˆã†ãªäº’æ›ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã€ç„¡äº‹ã« Polyfill ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

# useBuiltInsã‚’ç†è§£ã™ã‚‹

å‰é …ã§ã¯ `"useBuiltIns": "usage"` ã®ã‚ˆã†ã«ã€æ€è€ƒåœæ­¢ã§`useBuiltIns` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€`Promise`ã®Polyfillã‚’å®Ÿç¾ã—ã¦ã„ã¾ã—ãŸã€‚

ã“ã® `useBuiltIns` ã¨ã¯ã€ `@babel/preset-env` ã§ã©ã®ã‚ˆã†ã«Polyfillã‚’æ‰±ã†ã‹ã‚’æŒ‡å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ `"usage"` | `"entry"` | `"false"` ã®ã„ãšã‚Œã‹ã‚’å–ã‚Šã¾ã™ã€‚

|å€¤|åŠ¹æœ|
|---|---|
|"usage"|å„ãƒ•ã‚¡ã‚¤ãƒ«ã§å¿…è¦ã«ãªã£ãŸPolyfillã®ã¿é©ç”¨ã™ã‚‹|
|"entry"|`core-js`ã®importæ–‡ã‚’ã€å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã¨ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç½®ãæ›ãˆã‚‹|
|false|Polyfillã—ãªã„(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)|

æœ¬è¨˜äº‹åºç›¤ã§ã¯ã“ã‚Œã‚’æŒ‡å®šã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`false`ãŒè¨­å®šã•ã‚Œã€PolyfillãŒè¡Œã‚ã‚Œãªã‹ã£ãŸã‚“ã§ã™ã­ã€‚

`"usage"` `"entry"` ã¨ã‚‚ã«å°‘ã—ã‚„ã‚„ã“ã—ã„ã®ã§ã€ã‚‚ã†å°‘ã—æ·±å €ã‚Šã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

*â€» ä»¥å‰ã¯ `@babel/polyfill` ã‚’ä½¿ã£ã¦Polyfillã™ã‚‹ã®ãŒä¸»æµã§ã—ãŸãŒã€Babel7.4.0ã‹ã‚‰ã¯ã“ã‚ŒãŒéæ¨å¥¨ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€æœ¬è¨˜äº‹ã®å†…å®¹ã§å¯¾å¿œã™ã‚‹ã®ãŒæœ›ã¾ã—ã„ã§ã™*

## useBuiltIns: "usage"

`"usage"` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¨å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¦‹ã¦ã€å¿…è¦ãªPolyfillã®ã¿ã‚’è‰¯ã„æ„Ÿã˜ã«é©ç”¨ã—ã¦ãã‚Œã‚‹ã‚¹ã‚°ãƒ¬ãƒ¢ãƒã§ã™ã€‚

```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage",
        "corejs": 3
      }
    ]
  ]
}
```

æœ€æ–°ã® Chrome ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸå ´åˆã¯ Polyfill ã—ã¾ã›ã‚“ãŒ

```javascript
"use strict";

Promise.resolve();
```

IE11 ã‚’å¯¾è±¡ã«ã—ãŸå ´åˆã¯ Polyfill ã—ã¦ãã‚Œã¾ã™ã€‚

```javascript
"use strict";

require("core-js/modules/es.object.to-string");

require("core-js/modules/es.promise");

Promise.resolve();
```

ãŸã ã—ã€æ©Ÿæ¢°çš„ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã¨ã„ã†éƒ½åˆä¸Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒˆãƒªãƒƒã‚­ãƒ¼ãªå ´åˆãªã©ã¯ä¸Šæ‰‹ãæ‹¾ã£ã¦ãã‚Œãªã„ã®ã§ã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

```script.js
eval('Promise.resolve()')
```

```javascript:IEã‚’å¯¾è±¡ã«ã—ã¦ã‚‹ã®ã«Polyfillã•ã‚Œãªã„
"use strict";

eval('Promise.resolve()');
```

`eval` ã¯æ¥µç«¯ã«ã—ã¦ã‚‚ã€ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹ã«ã‚ˆã£ã¦ã¯ã—ã£ã‹ã‚Šæ‹¾ãˆã¦ã‚‚ã‚‰ãˆã‚‹ã‹ç¢ºè¨¼ãŒãªã„ã®ã§ã€ä½¿ç”¨ã™ã‚‹éš›ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚å¿ƒé…ã§ã‚ã‚Œã° `"entry"` ã‚’ä½¿ã†ã»ã†ãŒæœ›ã¾ã—ã„ã¨ã‚‚è¨€ãˆã¾ã™ã€‚

## useBuiltIns: "entry"

`"entry"` ã‚’ä½¿ã†å ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ä¸€åº¦`core-js`ã‚’importã—ã¾ã™ã€‚

```script.js
import 'core-js/stable'
Promise.resolve()
```

`useBuiltIns: "entry"` ã®å ´åˆã€å¯¾è±¡ãƒ–ãƒ©ã‚¦ã‚¶ã®å¯¾å¿œçŠ¶æ³ã«å¿œã˜ã¦ã€ä¸Šè¨˜ã®importã‚’ã€å¿…è¦æœ€ä½é™ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®importã«ç½®ãæ›ãˆã¦ãã‚Œã¾ã™ã€‚

```javascript
"use strict";

require("core-js/modules/web.immediate");

Promise.resolve();
```
*(web.immediateã¯[ã“ã‚Œ](https://developer.mozilla.org/en-US/docs/Web/API/Window/setImmediate) ã®ã“ã¨ã£ã½ã„ã‘ã©ã€è¦‹ãŸæ„Ÿã˜stableã«å…¥ã£ã¦ãªã•ãã†ãªã®ã«ä½•ã§ã ã‚)*

```javascript:safari13ã ã¨18å€‹
"use strict";

require("core-js/modules/es.promise.finally");

require("core-js/modules/es.string.replace");

require("core-js/modules/es.typed-array.float32-array");

require("core-js/modules/es.typed-array.float64-array");

require("core-js/modules/es.typed-array.int8-array");

require("core-js/modules/es.typed-array.int16-array");

require("core-js/modules/es.typed-array.int32-array");

require("core-js/modules/es.typed-array.uint8-array");

require("core-js/modules/es.typed-array.uint8-clamped-array");

require("core-js/modules/es.typed-array.uint16-array");

require("core-js/modules/es.typed-array.uint32-array");

require("core-js/modules/es.typed-array.from");

require("core-js/modules/es.typed-array.of");

require("core-js/modules/web.dom-collections.iterator");

require("core-js/modules/web.immediate");

require("core-js/modules/web.url");

require("core-js/modules/web.url.to-json");

require("core-js/modules/web.url-search-params");

Promise.resolve();
```

```javascript:IE11ã ã¨188å€‹
// (çœç•¥)
```

å½“ãŸã‚Šå‰ã§ã™ãŒã€ `core-js` ã‚’importã—ã¦ã„ãªã‹ã£ãŸã‚‰ä½•ã‚‚èµ·ã“ã‚‰ãªã„ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚

```javascript
// import 'core-js/stable'
Promise.resolve()
```

```javascript
"use strict";

Promise.resolve();
```

# çµè«–

IEã®ã‚µãƒãƒ¼ãƒˆã‚’åˆ‡ã‚Œã‚‹ãªã‚‰åˆ‡ã‚ã†
