---
title: "Storybook ã¨ react-docgen"
emoji: "ğŸ“•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Storybook", "React"]
published: false
---

# æ¦‚è¦

æœ¬è¨˜äº‹ã¯ã€[SmartHR Advent Calendar 2023](https://qiita.com/advent-calendar/2023/smarthr) ã®ã‚·ãƒªãƒ¼ã‚º2ã®7æ—¥ç›®ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Storybook ã‚’ [React](https://ja.react.dev/blog/2023/03/16/introducing-react-dev) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ãŸå ´åˆã«å†…éƒ¨çš„ã«åˆ©ç”¨ã•ã‚Œã‚‹ [react-docgen](https://github.com/reactjs/react-docgen) åŠã³ [react-docgen-typescript](https://github.com/styleguidist/react-docgen-typescript) ã«ã¤ã„ã¦ç´¹ä»‹ã—ã€ãã®ä»•çµ„ã¿ã‚’æ·±ã¼ã‚‹ã“ã¨ã§ Storybook ã®ç†è§£ã‚’æ·±ã‚ã‚‹ã‚ˆã†ã¨ã„ã†è¨˜äº‹ã§ã™ã€‚

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

- Storybook v7.6.3 (monorepo)
- react-docgen v7.0.1

# Storybook 7.6.0 ã®ãƒªãƒªãƒ¼ã‚¹

å…ˆæ—¥ã€Storybook v7.6.0 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€ä»¥ä¸‹ãƒ–ãƒ­ã‚°ã«ã¦ãƒªãƒªãƒ¼ã‚¹å†…å®¹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://storybook.js.org/blog/storybook-7-6/

v7.6.0 ã¯ã€å„ç¨®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨UXã®æ”¹å–„ã€åŠ ãˆã¦æ¬¡ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å‘ã‘ãŸãƒ¬ã‚¬ã‚·ãƒ¼æ©Ÿèƒ½ã®éæ¨å¥¨åŒ–ãŒä¸­å¿ƒã¨ãªã£ã¦ãŠã‚Šã€ããŸã‚‹ v8 ã«ã‚€ã‘ãŸ v7 æœ€å¾Œã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãªã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ä¸Šè¨˜ãƒ–ãƒ­ã‚°å†…ã§å–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã„ã‚‹ã€**react-docgen upgrade** ã«ã¤ã„ã¦æ·±æ˜ã‚Šã—ã¾ã™ã€‚

> **react-docgen upgrade**
>
> A major performance upgrade in Storybook 8 will be the switch to react-docgen for autogenerated controls. This might sound small but it will speed up startup times by 2x or more.

ã©ã†ã‚„ã‚‰ããŸã‚‹ Storybook v8 ã§ã¯ã€ãªã‚“ã‚‰ã‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ `react-docgen` ã«ä¹—ã‚Šæ›ãˆã‚‹ã“ã¨ã§ã€(React ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹) åˆå›èµ·å‹•æ™‚é–“ãŒåŠåˆ†ã«ãªã‚‹ã“ã¨ãŒè¦‹è¾¼ã‚ã‚‹ãã†ã§ã™ã€‚

ä¹—ã‚Šæ›ãˆå…ƒãƒ„ãƒ¼ãƒ«ãŒä½•ãªã®ã‹ã€ä½•ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã‹ã¯ã€[MIGRATION.md](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md) ã‹ã‚‰ç¢ºèªã§ãã¾ã—ãŸã€‚

https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#react-docgen-component-analysis-by-default

> **React-docgen component analysis by default**
>
> In Storybook 7, we used react-docgen-typescript to analyze React component props and auto-generate controls. In Storybook 8, we have moved to react-docgen as the new default.

ã“ã‚Œã«ã‚ˆã‚‹ã¨ã€`Controls` ã«è¡¨ç¤ºã™ã‚‹ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿(propsã®å‹å®šç¾©ãªã©)ã‚’è§£æã™ã‚‹ãŸã‚ã«ã€ã“ã‚Œã¾ã§ã¯ `react-docgen-typescript` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€Storybook 8 ã‹ã‚‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `react-docgen` ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰ã‚ã‚‹ãã†ã§ã™ã€‚

ãªãŠã€ `Controls` ã¨ã¯ã€Storybook ã«ãŠã‘ã‚‹ä¸»è¦æ©Ÿèƒ½ã®ä¸€ã¤ã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® Props ã‚’ç”»é¢ä¸Šã‹ã‚‰å·®ã—æ›¿ãˆã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«æç”»çµæœã‚’ç¢ºèªã§ãã‚‹ä»•çµ„ã¿ã§ã™ã€‚(ä»¥ä¸‹gifå‚ç…§)

![](https://storage.googleapis.com/zenn-user-upload/19a285efe8ea-20231204.gif)

`react-docgen`(å¾Œè¿°) ã¯ã€å…ƒã€… TypeScript ã«å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸãŸã‚ã€TypeScript å¯¾å¿œç‰ˆã¨ã—ã¦ `react-docgen-typescript` ãŒé–‹ç™ºã•ã‚Œã¾ã—ãŸãŒã€ç¾åœ¨ã§ã¯ `react-docgen` ã§ã‚‚æœ€ä½é™ ã® TypeScript ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€ä¹—ã‚Šæ›ãˆå¯èƒ½ã«ãªã£ãŸã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

MIGRATION.md ã«ã¯ä»¥ä¸‹ã®è¨˜è¼‰ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚

> react-docgen is dramatically more efficient, shaving seconds off of dev startup times. However, it only analyzes basic TypeScript constructs.
> We feel react-docgen is the right tradeoff for most React projects. However, if you need the full fidelity of react-docgen-typescript, you can opt-in using the following setting in .storybook/main.js:

- `react-docgen` ã¯é«˜é€Ÿã ãŒã‚·ãƒ³ãƒ—ãƒ«
- `react-docgen-typescript` ã¯ä½é€Ÿã ãŒå¤šæ©Ÿèƒ½

ã®é•ã„ãŒã‚ã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦ä½¿ã„åˆ†ã‘ã‚‹ã®ãŒé‡è¦ãªã‚ˆã†ã§ã™ã€‚

ã¾ãŸã€`react-docgen-typescript` ã¯æœ€çµ‚ãƒªãƒªãƒ¼ã‚¹ãŒ 2021å¹´12æœˆã§ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒè¡Œã‚ã‚Œã¦ã„ãªã„æ—¨ã‚‚ä»¥ä¸‹ Issue ã‹ã‚‰ã‚‚ç¢ºèªã§ãã‚‹ãŸã‚ã€ãã†ã„ã£ãŸèƒŒæ™¯ã‹ã‚‰ã‚‚é–‹ç™ºãŒæ´»ç™ºãª `react-docgen` ã‚’æ¡ç”¨ã—ãŸã¨æ€ãˆã¾ã™ã€‚

https://github.com/styleguidist/react-docgen-typescript/issues/494

Storybook ä¸Šã§ä½¿ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºæ¥ã¾ã™ã€‚

```ts
export default {
  typescript: {
    reactDocgen: 'react-docgen', // or react-docgen-typescript
  }
}
```

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æŒ‡å®šãŒãªã„å ´åˆã€Storybook ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

|Storybook|ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸|
|---|---|
|7.5.0|`react-docgen-typescript`|
|7.6.0|`react-docgen-typescript`|
|8.0.0|`react-docgen`|

ã“ã“ã‹ã‚‰ã¯ã€ä»Šå¾Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ãªã‚‹ `react-docgen` ã«ã¤ã„ã¦æ·±æ˜ã‚Šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

# react-docgen ã«ã¤ã„ã¦

æ”¹ã‚ã¾ã—ã¦ã€[react-docgen](https://github.com/reactjs/react-docgen) ã¯ã€React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€Props ã®å‹å®šç¾©ãªã©ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€JSON ãªã©ã§å‡ºåŠ›ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://github.com/reactjs/react-docgen

ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãª TypeScript ã§æ›¸ã‹ã‚ŒãŸ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```ts
import React from 'react'

type Props = {
  literal: "foo" | "bar" | "baz";
  object: {
    foo?: string;
    bar: number;
  };
  array?: Array<number | string>;
  func: (foo: string) => number;
};

/**
  Sample Component
**/
export const MyComponent: React.FC<Props> = ({ literal, object, array = [], func }) => {
  return <div>MyComponent</div>
};

```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè§£æã•ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ãª JSON ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```json
[
  {
    "description": "Sample Component",
    "displayName": "MyComponent",
    "methods": [],
    "props": {
      "literal": {
        "required": true,
        "tsType": {
          "name": "union",
          "raw": "\"foo\" | \"bar\" | \"baz\"",
          "elements": [
            {
              "name": "literal",
              "value": "\"foo\""
            },
            {
              "name": "literal",
              "value": "\"bar\""
            },
            {
              "name": "literal",
              "value": "\"baz\""
            }
          ]
        },
        "description": ""
      },
      "object": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "object",
          "raw": "{\n  foo?: string;\n  bar: number;\n}",
          "signature": {
            "properties": [
              {
                "key": "foo",
                "value": {
                  "name": "string",
                  "required": false
                }
              },
              {
                "key": "bar",
                "value": {
                  "name": "number",
                  "required": true
                }
              }
            ]
          }
        },
        "description": ""
      },
      "array": {
        "required": false,
        "tsType": {
          "name": "Array",
          "elements": [
            {
              "name": "union",
              "raw": "number | string",
              "elements": [
                {
                  "name": "number"
                },
                {
                  "name": "string"
                }
              ]
            }
          ],
          "raw": "Array<number | string>"
        },
        "description": "",
        "defaultValue": {
          "value": "[]",
          "computed": false
        }
      },
      "func": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "function",
          "raw": "(foo: string) => number",
          "signature": {
            "arguments": [
              {
                "type": {
                  "name": "string"
                },
                "name": "foo"
              }
            ],
            "return": {
              "name": "number"
            }
          }
        },
        "description": ""
      }
    }
  }
]
```

ä¸Šè¨˜ã®é€šã‚Šã€ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‹ã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæŠ½å‡ºã§ãã¾ã™ã€‚

- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
- Props
  - required or optional
  - å‹æƒ…å ±
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ

`react-docgen-typescript` ã¨æ¯”ã¹ã‚‹ã¨æ©Ÿèƒ½ãŒé™ã‚‰ã‚Œã‚‹ã¨ã¯è¨€ã‚ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã ã‘è¦‹ã‚‹ã¨ååˆ†å®Ÿç”¨çš„ãã†ã§ã™ã­ã€‚

# react-docgen ã‚’ä½¿ã£ã¦ã¿ã‚‹

`react-docgen` ã¯åŸºæœ¬ã¨ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã€ãã‚Œã‚’ç”¨ã„ãŸ CLI ã®2ç¨®é¡ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

CLI ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ yarn add -D @react-docgen/cli
$ yarn react-docgen component.ts -o result.json --pretty
```

ä»Šå›ã¯ã€ã‚ˆã‚Šä¸­èº«ã‚’æ·±ã¼ã‚‹ãŸã‚ã«ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç›´æ¥ä½¿ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ yarn add react-docgen
```

`react-docgen` ã§ã¯æ§˜ã€…ãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã®ã¾ã¾ã€ `parse` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã¿ã¾ã™ã€‚

```ts
import { parse } from 'react-docgen'

const code = `
type Props = {
  name?: string
}

/** My first component */
export const MyComponent: React.FC<Props> = ({ name = 'no_name'} ) => {
  return <div>Hello, {name}!</div>
}
`

const documentation = parse(code)

console.log(documentation)
```

`parse` é–¢æ•°ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’æ¸¡ã™ã ã‘ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‘ãƒ¼ã‚¹çµæœã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚åŸºæœ¬ã¯ã“ã‚Œã ã‘ã§ã™ã­ã€‚

```ts
[
  {
    "description": "My first component",
    "displayName": "MyComponent",
    "methods": [],
    "props": {
      "name": {
        "defaultValue": {
          "value": "'no_name'",
          "computed": false
        },
        "required": false
      }
    }
  }
]
```

ã§ã¯ã€ã“ã® `parse` é–¢æ•°ã‚’è»¸ã«ãã®ä»•çµ„ã¿ã‚’è¿½ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

# react-docgen ã®ä»•çµ„ã¿

`react-docgen` ã¯ã€ã©ã®ã‚ˆã†ã«ã—ã¦ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚

`package.json` ã‚’è¦—ã„ã¦ã¿ã‚‹ã¨ã€`babel` ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’ç”¨ã„ã¦ AST ã‚’ç”Ÿæˆã—ã¦ãã“ã‹ã‚‰æƒ…å ±ã‚’æŠœãå‡ºã™ã“ã¨ãŒæƒ³åƒã§ãã¾ã™ã€‚

https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/package.json#L41-L52

ãã‚Œã‚’è¸ã¾ãˆãŸä¸Šã§ã€å…ˆç¨‹ä½¿ç”¨ã—ãŸ `parse` é–¢æ•°ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã¾ã™ã€‚

https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/src/parse.ts#L43-L48

ã‚„ã¯ã‚Š `parse` é–¢æ•°ã§ã¯ã€ã¯ã˜ã‚ã«ã‚³ãƒ¼ãƒ‰ã‚’ `babel` ã‚’ç”¨ã„ã¦ãƒ‘ãƒ¼ã‚¹ã—ã€AST ã‚’å–å¾—ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

`babelParser` é–¢æ•°ã®ä¸­èº«ã‚‚ã€ç´°ã‹ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®èª¿æ•´ã¯ã‚ã‚‹ã‚‚ã®ã®ã€åŸºæœ¬çš„ã«ã¯ `@babe/core` ã® `parseSync` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã®ã¿ã§ã™ã€‚

https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/src/babelParser.ts#L71-L88

ã¡ãªã¿ã« `babel` ã¨è¨€ãˆã°ã‚³ãƒ¼ãƒ‰ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚’æƒ³åƒã—ã¾ã™ãŒã€ãã‚Œã¯ Babel ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½ã§ã‚ã‚Šã€ `@babel/core` ã®æŒã¤åŸºæœ¬çš„ãªæ˜¨æ—¥ã¯ AST ã‚’ç”Ÿæˆã—ã€(å¿…è¦ã«å¿œã˜ã¦)ãã‚Œã‚’æ›¸ãæ›ãˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹ã“ã¨ã§ã™ã€‚

`babel` ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸ AST ã¯ã€`FileState` ã¨ã„ã†ã€`react-docgen` å´ã§å®šç¾©ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¤‰æ›ã•ã‚Œã€`runResolver` é–¢æ•°ã«ã‚ˆã£ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æƒ…å ±ãŒæŠ½å‡ºã•ã‚Œã¾ã™ã€‚

https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/src/parse.ts#L50-L56

ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹ `importer` ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã§ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ä¾å­˜(`import`)ãŒã‚ã‚‹å ´åˆã«ã€é©åˆ‡ã«è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã€ãã¡ã‚‰ã‚‚ AST åŒ–ã—ã€`export` ã—ã¦ã„ã‚‹å‹å®šç¾©ãªã©ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`resolver` ã¯ã€AST å…¨ä½“ã‹ã‚‰ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©ã«é–¢ã‚ã‚‹ãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°ã§ã€AST ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ESM å½¢å¼ã‚„ CJS å½¢å¼ãªã©æ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

æœ€å¾Œã« `handlers` ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©ã«é–¢ã‚ã‚‹ AST ã‹ã‚‰æƒ…å ±ã‚’æŠœãå‡ºã—ã¾ã™ã€‚
https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/src/parse.ts#L62

`handlers` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

https://github.com/reactjs/react-docgen/blob/d82af943c6953920bfb2850552cafd9286531e98/packages/react-docgen/src/config.ts#L50-L62

ä¾‹ãˆã° [displayNameHandler](https://react-docgen.dev/docs/reference/handlers/display-name-handler) ã¯ã€ã‚¯ãƒ©ã‚¹åã‚„é–¢æ•°åãªã©ã‚’å…ƒã«ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåã®æƒ…å ±ã‚’æŠœãå‡ºã—ã€ [defaultPropsHandler](https://react-docgen.dev/docs/reference/handlers/default-props-handler) ã¯ props ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ã‚ãŸã‚‹æƒ…å ±ã‚’æŠœãå‡ºã—ã¾ã™ã€‚

ä»¥ä¸Šã®ã‚ˆã†ã«ã€ `react-docgen` ã§ã¯ `Babel` ã‚’ç”¨ã„ã¦ç”Ÿæˆã—ãŸ AST ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ `importer` `resolver` `handler` ã‚’çµŒã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```mermaid
graph LR
    code[code] -->|Babel| ast1[AST]
    ast1 --> fs[FileState]
    fs -->|Importer| otherFiles[Other Files]
    otherFiles -->|Babel| ast2[AST]
    ast2 --> fs
    fs -->|Resolver| cd[Component Definitions]
    cd -->|Handler| result[Result]
```

# Storybook ã§ã®ä½¿ç”¨ä¾‹

ã•ã¦ã€Storybook ã§ã¯ã€ `Controls` ã®æ©Ÿèƒ½ã®ä¸€ç’°ã¨ã—ã¦ `react-docgen` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ã®ã“ã¨ã§ã—ãŸã€‚

`react-doc-gen` ã‚’ä½¿ç”¨ã—ãŸä»•çµ„ã¿ã¯ã€Storybook ã®ãƒ“ãƒ«ãƒ‰ã« `Webpack` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ã€`Vite` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ Vite ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ãŒã€ã“ã“ã§ã¯å‰è€…ã«ã¤ã„ã¦æ·±æ˜ã‚Šã¾ã™ã€‚

:::message
ã“ã“ã‹ã‚‰ã¯ `Webpack` ã«é–¢ã™ã‚‹ç”¨èªãƒ»æ¦‚å¿µãŒç™»å ´ã—ã¾ã™ãŒã€è©³ã—ããªã„æ–¹ã‚‚é›°å›²æ°—ã§èª­ã‚“ã§ã„ãŸã ã„ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚
:::

`Webpack` å‘ã‘ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ã€ `react-docgen-loader` ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/storybookjs/storybook/blob/3bcca2d4765c1f6b8aaf87ce70916d51cac743c1/code/presets/react-webpack/src/loaders/react-docgen-loader.ts
https://github.com/storybookjs/storybook/blob/3bcca2d4765c1f6b8aaf87ce70916d51cac743c1/code/presets/react-webpack/src/loaders/react-docgen-loader.ts#L61-L116

ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯ç°¡å˜ã«è¨€ã†ã¨ã€`Webpack` ã«ã‚ˆã£ã¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£æ±ºãŒè¡Œã‚ã‚Œã‚‹éš›ã«ã€æ‹¡å¼µå­ã«å¿œã˜ãŸå‰å‡¦ç†ã‚’æŒŸã‚€ã“ã¨ãŒå‡ºæ¥ã‚‹ä»•çµ„ã¿ã§ã™ã€‚ä¾‹ãˆã° `ts-loader` ã®å ´åˆã€`.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾å­˜è§£æ±ºæ™‚ã« `tsc` ã«ã‚ˆã£ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’è¡Œã†ã¨ã„ã£ãŸä»•çµ„ã¿ã§ã™ã€‚

`react-docgen-loader` ã‚’ã„ã¤ä½¿ç”¨ã™ã‚‹ã‹ã¯ã€Storybook ãŒä½¿ç”¨ã™ã‚‹ `Webpack` ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/storybookjs/storybook/blob/3bcca2d4765c1f6b8aaf87ce70916d51cac743c1/code/presets/react-webpack/src/framework-preset-react-docs.ts#L22-L45

`reactDocgen` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å€¤ã«ã‚ˆã£ã¦ä½¿ç”¨ã™ã‚‹ãƒ­ãƒ¼ãƒ€ãƒ¼ãŒæ±ºå®šã—ã¦ãŠã‚Šã€`/\.(cjs|mjs|tsx?|jsx?)$/` ã‚’æº€ãŸã™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ±ºã™ã‚‹éš›ã« `react-docgen-loader` ãŒä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ãƒ­ãƒ¼ãƒ€ãƒ¼å´ã®å®Ÿè£…ã«æˆ»ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ãƒ€ãƒ¼ã§ã¯å½“ç„¶ `react-docgen` ã‚’ä½¿ç”¨ã—ã¦ã€`Webpack` ãŒè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚½ãƒ¼ã‚¹ã‚’ `parse` é–¢æ•°ã«æ¸¡ã—ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚

https://github.com/storybookjs/storybook/blob/afc4c2f4cfc23739b5086a5294eb52e8706d0925/code/presets/react-webpack/src/loaders/react-docgen-loader.ts#L73-L84

å–ã‚Šå‡ºã—ãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—åŒ–ã—ã€ãªã‚“ã¨å…ƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ‹¡å¼µã—ã¦å¤‰æ•°ã«ä»£å…¥ã™ã‚‹ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ”¹å¤‰ã—ã¦ã„ã¾ã™ã€‚ãªã‚“ã¨ãƒ‘ãƒ¯ãƒ•ãƒ«ãªã€‚

https://github.com/storybookjs/storybook/blob/afc4c2f4cfc23739b5086a5294eb52e8706d0925/code/presets/react-webpack/src/loaders/react-docgen-loader.ts#L86-L94

Storybook ã§æç”»ã™ã‚‹ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã«ã€`__docgenInfo` ã¨ã„ã†å¤‰æ•°ãŒç”Ÿãˆã‚‹å½¢ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã†ãªã£ã¦ã—ã¾ãˆã°ã€ã‚ã¨ã¯æç”»ã®éš›ã«ã„ãã‚‰ã§ã‚‚å‚ç…§å¯èƒ½ã§ã™ã€‚å‹æƒ…å ±ã¯ã“ã®ã‚ˆã†ã«å–å¾—ã•ã‚Œã¦ã„ãŸã‚“ã§ã™ã­ã€‚

https://github.com/storybookjs/storybook/blob/afc4c2f4cfc23739b5086a5294eb52e8706d0925/code/lib/docs-tools/src/argTypes/docgen/utils/docgenInfo.ts#L14-L16
https://github.com/storybookjs/storybook/blob/afc4c2f4cfc23739b5086a5294eb52e8706d0925/code/lib/docs-tools/src/argTypes/docgen/extractDocgenProps.ts#L71-L82

# ç· ã‚

æœ¬è¨˜äº‹ã§ã¯ã€Storybook ä¸Šã§ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‹æƒ…å ±ã‚’è‡ªå‹•ã§å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ `react-docgen` ã«ã¤ã„ã¦æ·±æ˜ã‚Šã¾ã—ãŸã€‚

æ™®æ®µã‹ã‚‰ãŠä¸–è©±ã«ãªã£ã¦ã„ã‚‹ Storybook ã§ã™ãŒã€ãã®ä»•çµ„ã¿ã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãªã‚ŠãŒã¡ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚‚ç©æ¥µçš„ãªè¿½å¾“ãŒå‡ºæ¥ã¦ã„ãªã„ã“ã¨ãŒå¤šã‹ã£ãŸã§ã™ã€‚

ä»Šå›ã®ã‚ˆã†ã«ã€ãƒ†ãƒ¼ãƒã‚’æ±ºã‚ã¦ä»•çµ„ã¿ã‚’æ·±ã¼ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Š Storybook ã‚’èº«è¿‘ã«æ„Ÿã˜ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«è¿½å¾“ã—ãŸæœ€é©ãªæ§‹æˆã‚’è‡ªã‚‰è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šãã†ãªã®ã§ã€OSS ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚‚å«ã‚ã¦ä»Šå¾Œã‚‚ç¶™ç¶šçš„ã«å–ã‚Šçµ„ã‚ãŸã‚‰ãªã¨æ€ã„ã¾ã™ã€‚