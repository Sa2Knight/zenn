---
title: "Storybook と react-docgen とパフォーマンス"
emoji: "📕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Storybook", "React"]
published: false
---

# 概要

本記事は、[SmartHR Advent Calendar 2023](https://qiita.com/advent-calendar/2023/smarthr) のシリーズ2の7日目です。

本記事では、Storybook を [React](https://ja.react.dev/blog/2023/03/16/introducing-react-dev) プロジェクトで使用した場合に内部的に利用される [react-docgen](https://github.com/reactjs/react-docgen) 及び [react-docgen-typescript](https://github.com/styleguidist/react-docgen-typescript) について紹介し、その仕組みを深ぼることで Storybook の理解をさらに深めることを目指します。

*※ 記事執筆時点では、Storybook の最新版は v7.6.3 で、 v8.0.0-alpha.0 がプレリリースされたばかりの状態です*

# Storybook 7.6.x のリリース

先日、Storybook v7.6.0 がリリースされ、リリース内容が詳解された以下ブログ記事が公開されました。
https://storybook.js.org/blog/storybook-7-6/

v7.6.0 は、各種パフォーマンスとUXの改善、加えて次のメジャーバージョンに向けたレガシー機能の非推奨化が中心で、きたる v8 にむけた v7 最後のパッチバージョンとなっています。

上記ブログを眺めていると、**react-docgen upgrade** という見出しが気になりました。

> A major performance upgrade in Storybook 8 will be the switch to react-docgen for autogenerated controls. This might sound small but it will speed up startup times by 2x or more.

どうやらきたる Storybook v8 では、なんらかのツールを `react-docgen` に乗り換えることで、(React プロジェクトにおける) 初回起動時間が半分になることが見込めるそうです。

乗り換え元ツールが何なのか、何ために使用しているのかを調べるために、[MIGRATION.md](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md) を確認したところ、以下の記載がありました。

> React-docgen component analysis by default
>
> In Storybook 7, we used react-docgen-typescript to analyze React component props and auto-generate controls. In Storybook 8, we have moved to react-docgen as the new default.

これによると、`Controls` に表示する React コンポーネントのメタデータを解析するために `react-docgen-typescript` を使用していたが、これを `react-docgen` に乗り換えることになるようです。

`Controls` とは、Storybook における主要機能の一つで、コンポーネントの Props を画面上から差し替え、リアルタイムに描画結果を確認できる仕組みです。

![](https://storage.googleapis.com/zenn-user-upload/19a285efe8ea-20231204.gif)

Storybook で描画する React コンポーネントを解析し、自動で Props の定義を抜き出すために `react-docgen-typescript` または `react-docgen` が使用されていたわけですね。

`react-docgen-typescript` は、元々 TypeScript に対応していなかった `react-docgen` の、TypeScript に特化した派生ツールだったようですが、現在は `react-docgen` についても、最低限 TypeScript をサポートするようになったため、乗り換え可能になったように見えます。

MIGRATION.md には以下の記載もありました。

> react-docgen is dramatically more efficient, shaving seconds off of dev startup times. However, it only analyzes basic TypeScript constructs.
> We feel react-docgen is the right tradeoff for most React projects. However, if you need the full fidelity of react-docgen-typescript, you can opt-in using the following setting in .storybook/main.js:

- `react-docgen` は高速だがシンプル
- `react-docgen-typescript` は低速だが多機能

の違いがあるため、プロジェクトによって使い分けるのが重要なようです。

パッケージの切り替えは、Storybook の設定ファイルにて以下のように出来ます。
これのデフォルト値が Storybook v8 からは `react-docgen` になるわけですね。

```ts
export default {
  typescript: {
    reactDocgen: 'react-docgen', // or react-docgen-typescript
  }
}
```

ここからは、今後デフォルトとなる `react-docgen` について深掘りしてみましょう。

# react-docgen について

改めまして、[react-docgen](https://github.com/reactjs/react-docgen) は、React コンポーネントのソースコードから、Props の型定義などのコンポーネントメタデータを抽出し、JSON などで出力できるツールです。

https://github.com/reactjs/react-docgen

例として、以下のような TypeScript で書かれた React コンポーネントのコードを入力します。

```ts
import React from 'react'

type Props = {
  literal: "foo" | "bar" | "baz";
  object: {
    foo?: string;
    bar: number;
  };
  array?: Array<number | string>;
  func: (foo: string) => number;
};

/**
  Sample Component
**/
export const MyComponent: React.FC<Props> = ({ literal, object, array = [], func }) => {
  return <div>MyComponent</div>
};

```

ソースコードが解析され、以下のような JSON が生成されます。

```json
[
  {
    "description": "Sample Component",
    "displayName": "MyComponent",
    "methods": [],
    "props": {
      "literal": {
        "required": true,
        "tsType": {
          "name": "union",
          "raw": "\"foo\" | \"bar\" | \"baz\"",
          "elements": [
            {
              "name": "literal",
              "value": "\"foo\""
            },
            {
              "name": "literal",
              "value": "\"bar\""
            },
            {
              "name": "literal",
              "value": "\"baz\""
            }
          ]
        },
        "description": ""
      },
      "object": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "object",
          "raw": "{\n  foo?: string;\n  bar: number;\n}",
          "signature": {
            "properties": [
              {
                "key": "foo",
                "value": {
                  "name": "string",
                  "required": false
                }
              },
              {
                "key": "bar",
                "value": {
                  "name": "number",
                  "required": true
                }
              }
            ]
          }
        },
        "description": ""
      },
      "array": {
        "required": false,
        "tsType": {
          "name": "Array",
          "elements": [
            {
              "name": "union",
              "raw": "number | string",
              "elements": [
                {
                  "name": "number"
                },
                {
                  "name": "string"
                }
              ]
            }
          ],
          "raw": "Array<number | string>"
        },
        "description": "",
        "defaultValue": {
          "value": "[]",
          "computed": false
        }
      },
      "func": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "function",
          "raw": "(foo: string) => number",
          "signature": {
            "arguments": [
              {
                "type": {
                  "name": "string"
                },
                "name": "foo"
              }
            ],
            "return": {
              "name": "number"
            }
          }
        },
        "description": ""
      }
    }
  }
]
```

上記の通り、 React コンポーネントのソースコード内で定義されている情報から、以下のようなメタデータが抽出できます。

- コンポーネント名
- ドキュメンテーションコメント
- Props
  - required or optional
  - 型情報
  - デフォルト値
  - ドキュメンテーションコメント

`react-docgen-typescript` と比べると機能が限られるとは言われていますが、これだけ見ると十分実用的そうですね。

なお、上記コードは [Playground](https://react-docgen.dev/playground) を用いて生成しましたが、CLI を使用することで手元でも確認可能です。

```bash
$ yarn add -D @react-docgen/cli
$ yarn react-docgen hoge.ts -o result.json --pretty
```