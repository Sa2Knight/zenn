---
title: "Storybook と react-docgen とパフォーマンス"
emoji: "📕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Storybook", "React"]
published: false
---

# 概要

本記事は、[SmartHR Advent Calendar 2023](https://qiita.com/advent-calendar/2023/smarthr) のシリーズ2の7日目です。

本記事では、Storybook を [React](https://ja.react.dev/blog/2023/03/16/introducing-react-dev) プロジェクトで使用した場合に内部的に利用される [react-docgen](https://github.com/reactjs/react-docgen) 及び [react-docgen-typescript](https://github.com/styleguidist/react-docgen-typescript) について紹介し、その仕組みを深ぼることで Storybook の理解を深めるようという記事です。

# バージョン情報

- Storybook v7.6.3 (monorepo)
- react-docgen v7.0.1

# Storybook 7.6.0 のリリース

先日、Storybook v7.6.0 がリリースされ、以下ブログにてリリース内容が紹介されています。
https://storybook.js.org/blog/storybook-7-6/

v7.6.0 は、各種パフォーマンスとUXの改善、加えて次のメジャーバージョンに向けたレガシー機能の非推奨化が中心となっており、きたる v8 にむけた v7 最後のパッチバージョンになります。

本記事では、上記ブログ内で取り上げられている、**react-docgen upgrade** について深掘りします。

> **react-docgen upgrade**
>
> A major performance upgrade in Storybook 8 will be the switch to react-docgen for autogenerated controls. This might sound small but it will speed up startup times by 2x or more.

どうやらきたる Storybook v8 では、なんらかのツールを `react-docgen` に乗り換えることで、(React プロジェクトにおける) 初回起動時間が半分になることが見込めるそうです。

乗り換え元ツールが何なのか、何ために使用しているのかは、[MIGRATION.md](https://github.com/storybookjs/storybook/blob/next/MIGRATION.md) から確認できました。

https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#react-docgen-component-analysis-by-default

> **React-docgen component analysis by default**
>
> In Storybook 7, we used react-docgen-typescript to analyze React component props and auto-generate controls. In Storybook 8, we have moved to react-docgen as the new default.

これによると、`Controls` に表示する React コンポーネントのメタデータ(propsの型定義など)を解析するために、これまでは `react-docgen-typescript` を使用していましたが、Storybook 8 からはデフォルトで `react-docgen` が使用されるように変わるそうです。

なお、 `Controls` とは、Storybook における主要機能の一つで、コンポーネントの Props を画面上から差し替え、リアルタイムに描画結果を確認できる仕組みです。(以下gif参照)

![](https://storage.googleapis.com/zenn-user-upload/19a285efe8ea-20231204.gif)

`react-docgen`(後述) は、元々 TypeScript に対応していなかったため、TypeScript 対応版として `react-docgen-typescript` が開発されましたが、現在では `react-docgen` でも最低限 の TypeScript をサポートするようになったため、乗り換え可能になったように見えます。

MIGRATION.md には以下の記載もありました。

> react-docgen is dramatically more efficient, shaving seconds off of dev startup times. However, it only analyzes basic TypeScript constructs.
> We feel react-docgen is the right tradeoff for most React projects. However, if you need the full fidelity of react-docgen-typescript, you can opt-in using the following setting in .storybook/main.js:

- `react-docgen` は高速だがシンプル
- `react-docgen-typescript` は低速だが多機能

の違いがあるため、プロジェクトによって使い分けるのが重要なようです。

また、`react-docgen-typescript` は最終リリースが 2021年12月で、メンテナンスが行われていない旨も以下 Issue からも確認できるため、そういった背景からも開発が活発な `react-docgen` を採用したと思えます。

https://github.com/styleguidist/react-docgen-typescript/issues/494

Storybook 上で使用するパッケージの切り替えは、設定ファイルにて以下のように出来ます。

```ts
export default {
  typescript: {
    reactDocgen: 'react-docgen', // or react-docgen-typescript
  }
}
```

パッケージの指定がない場合、Storybook のバージョンに応じて以下のようにデフォルトパッケージが使用されます。

|Storybook|デフォルトパッケージ|
|---|---|
|7.5.0|`react-docgen-typescript`|
|7.6.0|`react-docgen-typescript`|
|8.0.0|`react-docgen`|

ここからは、今後デフォルトとなる `react-docgen` について深掘りしてみましょう。

# react-docgen について

改めまして、[react-docgen](https://github.com/reactjs/react-docgen) は、React コンポーネントのソースコードから、Props の型定義などのコンポーネントメタデータを抽出し、JSON などで出力できるツールです。

https://github.com/reactjs/react-docgen

例として、以下のような TypeScript で書かれた React コンポーネントのコードを入力します。

```ts
import React from 'react'

type Props = {
  literal: "foo" | "bar" | "baz";
  object: {
    foo?: string;
    bar: number;
  };
  array?: Array<number | string>;
  func: (foo: string) => number;
};

/**
  Sample Component
**/
export const MyComponent: React.FC<Props> = ({ literal, object, array = [], func }) => {
  return <div>MyComponent</div>
};

```

ソースコードが解析され、以下のような JSON が生成されます。

```json
[
  {
    "description": "Sample Component",
    "displayName": "MyComponent",
    "methods": [],
    "props": {
      "literal": {
        "required": true,
        "tsType": {
          "name": "union",
          "raw": "\"foo\" | \"bar\" | \"baz\"",
          "elements": [
            {
              "name": "literal",
              "value": "\"foo\""
            },
            {
              "name": "literal",
              "value": "\"bar\""
            },
            {
              "name": "literal",
              "value": "\"baz\""
            }
          ]
        },
        "description": ""
      },
      "object": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "object",
          "raw": "{\n  foo?: string;\n  bar: number;\n}",
          "signature": {
            "properties": [
              {
                "key": "foo",
                "value": {
                  "name": "string",
                  "required": false
                }
              },
              {
                "key": "bar",
                "value": {
                  "name": "number",
                  "required": true
                }
              }
            ]
          }
        },
        "description": ""
      },
      "array": {
        "required": false,
        "tsType": {
          "name": "Array",
          "elements": [
            {
              "name": "union",
              "raw": "number | string",
              "elements": [
                {
                  "name": "number"
                },
                {
                  "name": "string"
                }
              ]
            }
          ],
          "raw": "Array<number | string>"
        },
        "description": "",
        "defaultValue": {
          "value": "[]",
          "computed": false
        }
      },
      "func": {
        "required": true,
        "tsType": {
          "name": "signature",
          "type": "function",
          "raw": "(foo: string) => number",
          "signature": {
            "arguments": [
              {
                "type": {
                  "name": "string"
                },
                "name": "foo"
              }
            ],
            "return": {
              "name": "number"
            }
          }
        },
        "description": ""
      }
    }
  }
]
```

上記の通り、 React コンポーネントのソースコード内で定義されている情報から、以下のようなメタデータが抽出できます。

- コンポーネント名
- ドキュメンテーションコメント
- Props
  - required or optional
  - 型情報
  - デフォルト値
  - ドキュメンテーションコメント

`react-docgen-typescript` と比べると機能が限られるとは言われていますが、これだけ見ると十分実用的そうですね。

なお、上記コードは [Playground](https://react-docgen.dev/playground) を用いて生成しましたが、CLI を使用することで手元でも確認可能です。

```bash
$ yarn add -D @react-docgen/cli
$ yarn react-docgen hoge.ts -o result.json --pretty
```